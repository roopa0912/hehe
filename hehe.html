# Retry: create HTML using token replacement to avoid f-string brace issues.
import base64, pathlib

def b64(path):
    with open(path, "rb") as f:
        return "data:image/png;base64," + base64.b64encode(f.read()).decode("ascii")

assets = {
    "BEAR": b64("/mnt/data/cute_bear.png"),
    "BLACK_HEART": b64("/mnt/data/black_heart.png"),
    "PINK_HEART": b64("/mnt/data/pink_heart.png"),
    "GIVE_HEART": b64("/mnt/data/give_heart.png"),
    "FLOWERS": b64("/mnt/data/flowers.png"),
    "CAT_HI": b64("/mnt/data/cat_hi.png"),
    "CAT_HEART": b64("/mnt/data/cat_heart.png"),
}

template = """<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roopa → Viswanath — a tiny postcard</title>
<link href="https://fonts.googleapis.com/css2?family=Homemade+Apple&display=swap" rel="stylesheet">
<style>
  :root{
    --paper:#f6f1e7;
    --ink:#222;
    --ink-soft:#444;
    --tape:#f0e6d6;
    --shadow: 0 15px 35px rgba(0,0,0,.15);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(800px 500px at 20% -10%, #fff8, transparent 60%),
      radial-gradient(1000px 600px at 100% 120%, #fff8, transparent 60%),
      linear-gradient(180deg, #eee9df, #f8f5ef);
    font-family: "Homemade Apple", cursive;
    color:var(--ink);
    display:grid; place-items:center;
  }

  .desk{
    position:relative; width:min(860px, 94vw); height:min(560px, 75vh);
    perspective: 1400px;
  }

  .postcard{
    position:absolute; inset:0; transform-style:preserve-3d;
    transition: transform .9s cubic-bezier(.2,.8,.2,1);
  }
  .open .postcard{ transform: rotateY(180deg) translateZ(1px); }

  .side{
    position:absolute; inset:0; border-radius:18px; box-shadow:var(--shadow);
    background: var(--paper);
    background-image:
      radial-gradient(2px 2px at 16px 24px, #d6cdbf 10%, transparent 12%),
      radial-gradient(2px 1.5px at 140px 80px, #e4dbcc 10%, transparent 12%),
      linear-gradient(transparent 0 98%, rgba(0,0,0,.04) 99%);
    backface-visibility:hidden;
    overflow:hidden;
    border:1px solid #e7dfd3;
  }
  .front{ padding:28px 28px 36px; display:flex; align-items:center; justify-content:center; gap:24px; }
  .back{ transform: rotateY(180deg); padding:28px 26px; }

  /* masking tape corners */
  .tape{
    position:absolute; width:72px; height:22px; background:var(--tape);
    box-shadow: 0 4px 10px rgba(0,0,0,.08) inset, 0 4px 10px rgba(0,0,0,.08);
    transform: rotate(-3deg);
    opacity:.9;
  }
  .t1{ top:-8px; left:28px; }
  .t2{ top:-10px; right:36px; transform: rotate(6deg); }
  .t3{ bottom:-10px; left:40%; transform: rotate(-4deg); }

  .bear{ width:min(300px, 40vw); filter: drop-shadow(0 8px 10px rgba(0,0,0,.08)); }
  .doodle{ position:absolute; opacity:.92; transition: transform .2s ease; }
  .doodle:hover{ transform: rotate(-2deg) scale(1.04); }
  .d-heart{ width:80px; }
  .d-flowers{ width:110px; }
  .d-cat{ width:120px; }
  .d-pink{ width:90px; }
  .d-give{ width:120px; }

  .title{ font-size: clamp(22px, 3.6vw, 32px); text-align:center; line-height:1.2; }
  .hint{ font-size: clamp(14px, 2.4vw, 16px); text-align:center; opacity:.75; margin-top:8px; }
  .front-note{ max-width: 440px; font-size: clamp(18px, 3vw, 22px); text-align:center; }

  .flip-badge{
    position:absolute; right:18px; bottom:14px; padding:8px 12px; border:1px dashed #cfc7bb;
    border-radius:14px; background:#fff6; backdrop-filter: blur(4px);
    cursor:pointer; user-select:none;
  }

  /* back side */
  .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; height:100%; }
  .letter{ border:1px dashed #cfc7bb; border-radius:14px; padding:16px 18px; position:relative; }
  .letter h2{ margin:0 0 8px; font-size:clamp(20px,3.2vw,26px)}
  .letter p{ margin:8px 0; font-size:clamp(16px,2.6vw,20px); color:var(--ink-soft);}
  .sticky{ position:absolute; right:-6px; top:-8px; transform: rotate(3deg); padding:10px 12px;
           background:#fff7; border:1px solid #e5dccf; border-radius:10px; }
  .sticky small{ font-size: clamp(13px, 2.2vw, 14px); }
  .sticky:hover{ transform: rotate(0deg) scale(1.02); }

  .notes{ border:1px dashed #cfc7bb; border-radius:14px; padding:12px; display:grid; gap:10px; }
  .note{ background:#fff; border:1px solid #e4dbcc; border-radius:10px; padding:10px 12px;
          transition: transform .12s ease; position:relative; min-height:66px; }
  .note:hover{ transform: translateY(-2px) rotate(-.5deg); }
  .note b{ display:block; margin-bottom:4px; }

  .reveal{ opacity:.0; transform: translateY(6px); transition:all .25s ease; }
  .note.open .reveal{ opacity:1; transform:none; }

  /* hearts rain */
  .sky{ pointer-events:none; position:fixed; inset:0; overflow:hidden; }
  .heart{ position:absolute; width:24px; opacity:.9; animation: floatUp linear forwards; }
  @keyframes floatUp{ 0%{ transform: translateY(20vh) rotate(-6deg); opacity:.95; } 100%{ transform: translateY(-120vh) rotate(12deg); opacity:0; } }

  .footer{ position:absolute; left:0; right:0; bottom:-46px; text-align:center; font-size:14px; opacity:.65; }

  .sr-only{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }
</style>
</head>
<body>
<div class="desk" id="desk">
  <div class="sky" id="sky" aria-hidden="true"></div>
  <div class="postcard" id="pc">
    <div class="side front">
      <div class="tape t1"></div>
      <div class="tape t2"></div>
      <img class="bear" src="%%BEAR%%" alt="two cozy bears hugging">
      <div>
        <div class="title">for Viswanath</div>
        <div class="front-note">I wrote you a tiny postcard. flip it over ↓</div>
        <div class="hint">(it’s a little silly, a little cozy, and 100% honest)</div>
      </div>

      <!-- doodles on front -->
      <img class="doodle d-heart" style="left:24px; top:28px" src="%%BLACK_HEART%%" alt="drawn heart">
      <img class="doodle d-flowers" style="left:38px; bottom:36px" src="%%FLOWERS%%" alt="tiny flowers">
      <img class="doodle d-cat" style="right:36px; bottom:44px" src="%%CAT_HI%%" alt="tiny cat peeking">
      <img class="doodle d-pink" style="right:24px; top:36px" src="%%PINK_HEART%%" alt="pink heart bubble">
      <div class="flip-badge" id="flip1">tap to flip</div>
    </div>

    <div class="side back">
      <div class="grid">
        <div class="letter">
          <div class="sticky"><small>psst—open me again later</small></div>
          <h2>i love you.</h2>
          <p>i miss you in the small, ordinary moments—the stove clicking on, the quiet after a laugh, the walk from the door to the sofa.</p>
          <p>if feelings could doodle, they'd draw us as two bears who keep finding each other.</p>
          <p>this is me waving from my side of the day: hi, silly human. you are my favorite person.</p>
          <img class="doodle d-give" style="position:absolute; left:-6px; bottom:-8px" src="%%GIVE_HEART%%" alt="little figure giving a heart">
          <div class="footer">made by roopa, for v.</div>
        </div>
        <div class="notes">
          <div class="note" onclick="toggleNote(this)">
            <b>bear fact</b>
            <div class="reveal">you’re the soft side of my hoodie.</div>
          </div>
          <div class="note" onclick="toggleNote(this)">
            <b>tonight’s plan</b>
            <div class="reveal">call me. i’ll bring the worst jokes and the best attention.</div>
          </div>
          <div class="note" onclick="toggleNote(this)">
            <b>evidence</b>
            <div class="reveal">i kept your tea mug on the desk like a museum piece.</div>
          </div>
          <div class="note" onclick="toggleNote(this)">
            <b>p.s.</b>
            <div class="reveal">i’d still pick you in a room full of snacks.</div>
          </div>
          <div class="note" onclick="toggleNote(this)">
            <b>one more</b>
            <div class="reveal">i love you more than i planned to. which is perfect.</div>
          </div>
        </div>
      </div>
      <div class="tape t3"></div>
      <div class="flip-badge" id="flip2">flip back</div>
    </div>
  </div>
</div>

<button class="sr-only" id="flipHidden" aria-label="flip postcard">flip</button>

<script>
  const pc = document.getElementById('pc');
  const desk = document.getElementById('desk');
  const sky = document.getElementById('sky');
  function flip(){ pc.parentElement.classList.toggle('open'); rain(26); }
  document.getElementById('flip1').addEventListener('click', flip);
  document.getElementById('flip2').addEventListener('click', flip);
  document.getElementById('flipHidden').addEventListener('click', flip);
  desk.addEventListener('dblclick', flip);

  function toggleNote(el){ el.classList.toggle('open'); }

  // gentle heart rain using black heart image
  const heartSrc = "%%BLACK_HEART%%";
  function drop(x){
    const h = document.createElement('img');
    h.src = heartSrc; h.className='heart';
    h.style.left = (x ?? Math.random()*window.innerWidth) + 'px';
    h.style.bottom = '-40px';
    h.style.animationDuration = (2600+Math.random()*1800)+'ms';
    h.style.width = (16+Math.random()*20)+'px';
    sky.appendChild(h);
    setTimeout(()=> h.remove(), 4600);
  }
  function rain(n=18){
    for(let i=0;i<n;i++){ setTimeout(()=> drop(), i*80); }
  }
</script>
</body>
</html>
"""

# Replace tokens
for k,v in assets.items():
    template = template.replace(f"%%{k}%%", v)

out = "/mnt/data/roopa_to_viswanath_postcard.html"
pathlib.Path(out).write_text(template, encoding="utf-8")
out
